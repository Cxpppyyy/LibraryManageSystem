CREATE DEFINER=`root`@`localhost` PROCEDURE `PopulateBookDetails`()
BEGIN
    DECLARE finished INTEGER DEFAULT 0;
    DECLARE b_id INT;
    DECLARE b_name VARCHAR(255);
    DECLARE b_publisher VARCHAR(255);
    DECLARE b_pub_date DATE;
    DECLARE b_total_stock INT;
    DECLARE b_available_books INT;
    DECLARE cur1 CURSOR FOR SELECT book_info_id, book_name, publisher, publication_date, total_stock, available_books FROM bookinfo;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;

    OPEN cur1;

    read_loop: LOOP
        FETCH cur1 INTO b_id, b_name, b_publisher, b_pub_date, b_total_stock, b_available_books;
        IF finished = 1 THEN 
            LEAVE read_loop;
        END IF;

        SET @i = 0;
        WHILE @i < b_total_stock DO
            IF @i < b_total_stock - b_available_books THEN
                -- 标记为已借阅
                INSERT INTO bookdetails (book_name, publisher, publication_date, book_info_id, is_borrowed) VALUES (b_name, b_publisher, b_pub_date, b_id, 1);
            ELSE
                -- 标记为未借阅
                INSERT INTO bookdetails (book_name, publisher, publication_date, book_info_id, is_borrowed) VALUES (b_name, b_publisher, b_pub_date, b_id, 0);
            END IF;
            SET @i = @i + 1;
        END WHILE;
    END LOOP;

    CLOSE cur1;
END